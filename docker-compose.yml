# Banana API Docker Compose Configuration
# 
# Quick Start:
#   1. cp .env.example .env && edit .env
#   2. docker-compose up -d
#   3. Access at http://localhost:3001
#
# Using MySQL instead of PostgreSQL:
#   1. Comment out the postgres service and SQL_DSN
#   2. Uncomment the mysql service and SQL_DSN
#   3. Uncomment mysql in depends_on
#   4. Uncomment mysql_data in volumes section
#
# ⚠️  IMPORTANT: Change all default passwords before deploying to production!

version: '3.8'

services:
  banana-api:
    image: calciumion/new-api:latest
    # Or build from source:
    # build: .
    container_name: banana-api
    restart: always
    command: --log-dir /app/logs
    ports:
      - "3001:3000"
    volumes:
      - ./data:/data
      - ./logs:/app/logs
    environment:
      - SQL_DSN=${SQL_DSN:-postgresql://root:123456@postgres:5432/banana}
      # - SQL_DSN=root:123456@tcp(mysql:3306)/banana  # Uncomment for MySQL
      - REDIS_CONN_STRING=redis://redis
      - TZ=${TZ:-Asia/Shanghai}
      - SESSION_SECRET=${SESSION_SECRET}
      - ERROR_LOG_ENABLED=true
      - BATCH_UPDATE_ENABLED=true
      # - STREAMING_TIMEOUT=300
      # - SYNC_FREQUENCY=60
    depends_on:
      - redis
      - postgres
      # - mysql  # Uncomment if using MySQL
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O - http://localhost:3000/api/status | grep -o '\"success\":\\s*true' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - banana-network

  redis:
    image: redis:latest
    container_name: banana-redis
    restart: always
    networks:
      - banana-network

  postgres:
    image: postgres:15-alpine
    container_name: banana-db
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-root}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-123456}
      POSTGRES_DB: ${POSTGRES_DB:-banana}
    volumes:
      - pg_data:/var/lib/postgresql/data
    # ports:
    #   - "5432:5432"  # Uncomment to expose PostgreSQL
    networks:
      - banana-network

#  mysql:
#    image: mysql:8.2
#    container_name: banana-mysql
#    restart: always
#    environment:
#      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-123456}
#      MYSQL_DATABASE: ${MYSQL_DATABASE:-banana}
#    volumes:
#      - mysql_data:/var/lib/mysql
#    # ports:
#    #   - "3306:3306"
#    networks:
#      - banana-network

networks:
  banana-network:
    driver: bridge

volumes:
  pg_data:
#  mysql_data:
